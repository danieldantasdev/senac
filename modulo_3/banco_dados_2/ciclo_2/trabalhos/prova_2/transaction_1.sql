CREATE PROCEDURE T1 (@codm int, @codp int, @data VARCHAR(50), @hora time)
AS

BEGIN
  
  BEGIN TRY
  IF NOT EXISTS (SELECT * FROM Consultas WHERE (codm = @codm OR codp = @codp) AND hora = @hora)

  BEGIN TRANSACTION
    INSERT INTO Consultas(codm, codp, data, hora) VALUES (@codm, @codp, @data, @hora)
    PRINT('INSERIDO COM SUCESSO')
  COMMIT TRANSACTION
  -- SELECT @@IDENTITY FROM Consultas
  END TRY

  BEGIN CATCH
      PRINT('NÃO FOI POSSÍVEL REALIZAR A TRANSAÇÃO')
  -- ROLLBACK TRANSACTION
  END CATCH
END

EXECUTE T1 51, 1011, "2010-10-04", "21:46:03";
EXECUTE T1 49, 1070, "2022/08/01", "09:00";
EXECUTE T1 49, 1030, "2022/08/01", "09:00";
EXECUTE T1 50, 1030, "2022/08/01", "09:30";
EXECUTE T1 49, 1070, "2022/08/01", "09:00";
EXECUTE T1 51, 1030, "2022/08/01", "09:30";
EXECUTE T1 51, 1030, "2022/08/01", "07:30:00";

SELECT * FROM Consultas WHERE hora = '21:40:00';

GO

DROP PROCEDURE T1

GO